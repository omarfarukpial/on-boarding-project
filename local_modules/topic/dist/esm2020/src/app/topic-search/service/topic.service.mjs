import { Injectable } from '@angular/core';
import { EndecapodService, SearchResult } from '@ibfd/endecapod';
import { Subject, BehaviorSubject, of } from 'rxjs';
import { catchError, filter, map, first, concatMap, take } from 'rxjs/operators';
import { cloneDeep } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "@ibfd/endecapod";
import * as i2 from "./taxtopics-provider.service";
import * as i3 from "@angular/router";
import * as i4 from "@angular/common/http";
export class TopicService {
    constructor(urlSerializer, taxtopicProviderSvc, router, http) {
        this.urlSerializer = urlSerializer;
        this.taxtopicProviderSvc = taxtopicProviderSvc;
        this.error = new BehaviorSubject(false);
        this.initTopicSvc = new EndecapodService(http, router, urlSerializer);
    }
    registerConfig(config) {
        this.topicConfig = config.topicConfig;
        this._endecaUrl = config.endecapodUrl;
        this._awareUrl = config.awareUrl;
        this._suppressedChips = config.suppressedChips;
    }
    loadInitTaxTopics() {
        this.shouldFetchInitialTaxtopics()
            .pipe(filter(Boolean), take(1))
            .subscribe(() => this.fetchInitialTaxtopics());
        this.getTopicValues(this.initTopicSvc.Result())
            .pipe(map(res => {
            const topics = res.topics;
            Object.keys(topics).map(e => topics[e])
                .forEach(obj => obj['selectable'] = false);
            return topics;
        }), take(1), catchError(this.handle_error))
            .subscribe(t => {
            this.taxtopicProviderSvc.addTaxtopicsGroup(t, this.topicConfig.id);
        });
        return true;
    }
    shouldFetchInitialTaxtopics() {
        const initQuery = this.topicConfig.query;
        if (!initQuery || initQuery.length === 0) {
            return of(true);
        }
        return this.taxtopicProviderSvc.isTaxtopicsGroupExist(this.topicConfig.id)
            .pipe(map(exist => !exist));
    }
    fetchInitialTaxtopics() {
        this.initTopicSvc.setName('TopicTreeInitService');
        this.initTopicSvc.setURL(this._endecaUrl, this._awareUrl);
        this.initTopicSvc.RegisterParams(this.urlSerializer.parse('?' + this.topicConfig.query).queryParamMap);
        this.initTopicSvc.DoSearch();
    }
    buildTopicTree(searchedTopics, expandedNodes) {
        this.taxtopicProviderSvc.getTaxtopics(this.topicConfig.id)
            .pipe(filter(taxtopics => !!taxtopics))
            .subscribe({
            next: taxtopics => {
                // Updating taxonomy taxtopics by searched topics from endeca
                const clonedTaxtopics = cloneDeep(taxtopics);
                this.updateAvailableTopics(clonedTaxtopics, Object.keys(searchedTopics['topics']));
                this.topicTreeProvider.next(this.buildPrimeNgTree(clonedTaxtopics, searchedTopics['chips'], expandedNodes));
            },
            error: err => { this.error.next(err); }
        });
    }
    buildDocTopicTree(topicCodes) {
        this.taxtopicProviderSvc.getTaxtopics(this.topicConfig.id)
            .pipe(filter(taxtopics => !!taxtopics))
            .subscribe({
            next: taxtopics => {
                const clonedTaxtopics = cloneDeep(taxtopics);
                this.updateAvailableDocTopics(clonedTaxtopics, topicCodes);
                const docTopicTree = this.buildPrimeNgTree(clonedTaxtopics, [], new Set()).data;
                this.docTopicTreeProvider.next(docTopicTree);
            },
            error: err => { this.error.next(err); }
        });
    }
    updateAvailableDocTopics(taxtopics, topicCodes) {
        topicCodes.forEach(topicCode => {
            const taxtopic = taxtopics[topicCode];
            if (taxtopic) {
                taxtopic.selectable = true;
                let parentLabel = this.getTaxtopicParentLabel(topicCode);
                while (parentLabel.lastIndexOf('_') > 0) {
                    const parent = taxtopics[parentLabel];
                    if (parent) {
                        parent.selectable = true;
                    }
                    parentLabel = this.getTaxtopicParentLabel(parentLabel);
                }
            }
        });
    }
    updateAvailableTopics(taxtopics, topicCodes) {
        topicCodes.forEach(topicCode => {
            const taxtopic = taxtopics[topicCode];
            if (taxtopic) {
                taxtopic.selectable = true;
            }
        });
    }
    getTopicTree() {
        return (this.topicTreeProvider = this.topicTreeProvider || new Subject()).asObservable();
    }
    getDocTopicTree() {
        return (this.docTopicTreeProvider = this.docTopicTreeProvider || new Subject()).asObservable();
    }
    buildPrimeNgTree(taxtopics, chips, expandedNodes) {
        return Object.keys(taxtopics)
            .map(e => taxtopics[e])
            .reduce((acc, taxtopic) => {
            const node = {
                label: taxtopic['label'],
                data: taxtopic['code'],
                selectable: taxtopic['selectable'],
                id: taxtopic['id'],
                key: taxtopic['code']
            };
            if (chips.find(id => id === node.id)) {
                acc.selected.push(node);
            }
            node['expanded'] = expandedNodes.has(node.id);
            const parent = this.getTaxtopicParent(acc.data, this.getTaxtopicParentLabel(node.data));
            if (parent) {
                if (!parent['children']) {
                    parent['children'] = [];
                }
                node['parent'] = parent;
                parent['children'].push(node);
            }
            else {
                acc.data.push(node);
            }
            return acc;
        }, { data: [], selected: [] });
    }
    getTaxtopicParentLabel(tc) {
        return tc.substring(0, tc.lastIndexOf('_'));
    }
    getTaxtopicParent(acc, parentLabel) {
        for (let i = 0; i < acc.length; i++) {
            const taxtopic = acc[i];
            if (taxtopic['data'] === parentLabel) {
                return taxtopic;
            }
            if (taxtopic['children']) {
                const taxtopicParent = this.getTaxtopicParent(taxtopic['children'], parentLabel);
                if (taxtopicParent) {
                    return taxtopicParent;
                }
            }
        }
    }
    searchTopics(topicExposeService, endecapodService) {
        return endecapodService.runningquery().pipe(filter(rq => !!rq), concatMap(q => {
            topicExposeService.ExposeMultipleOnExisting(endecapodService, this.topicConfig.dimensions.map(dim => dim.id), this.topicConfig.dimensions.map(dim => dim.name).join(','));
            return this.getTopicValues(topicExposeService.Result());
        }));
    }
    getTopicValues(searchresult) {
        return searchresult.pipe(filter(res => res instanceof SearchResult), map((res) => {
            let topics = [];
            this.topicConfig.dimensions
                .forEach(d => {
                topics = topics.concat(res.getDimensionValuesOrAssociated(d));
            });
            const chips = res.getChips()
                .filter(c1 => !this._suppressedChips.find(s => c1.parent.id === s))
                .map(chip => chip.dimension.id);
            return { topics: topics, chips: chips };
        }), first(), map(obj => {
            const topics = obj.topics
                .map(topic => {
                const name = topic.name;
                return {
                    code: name.substring(0, name.indexOf(' ')),
                    label: name.substring(name.indexOf(' ') + 1),
                    id: topic.id
                };
            })
                .sort((t1, t2) => t1.code.localeCompare(t2.code, undefined, { numeric: true, sensitivity: 'base' }))
                .reduce((acc, topic) => {
                return Object.assign(acc, { [topic['code']]: topic });
            }, {});
            return { topics: topics, chips: obj.chips };
        }), first(), catchError(this.handle_error));
    }
    handle_error(error, caught) {
        let errMsg;
        if (error instanceof Response) {
            const err = error.json().then(json => JSON.stringify(json)) || '';
            errMsg = `${error.status} - ${error.statusText || ''} ${err}`;
        }
        else {
            errMsg = error.message ? error.message : error.toString();
        }
        throw (new Error(errMsg));
    }
    getError() {
        return this.error.asObservable();
    }
}
TopicService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.4.0", ngImport: i0, type: TopicService, deps: [{ token: i1.EdcaUrlSerializer }, { token: i2.TaxtopicsProviderService }, { token: i3.Router }, { token: i4.HttpClient }], target: i0.ɵɵFactoryTarget.Injectable });
TopicService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.4.0", ngImport: i0, type: TopicService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.4.0", ngImport: i0, type: TopicService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.EdcaUrlSerializer }, { type: i2.TaxtopicsProviderService }, { type: i3.Router }, { type: i4.HttpClient }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9waWMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9hcHAvdG9waWMtc2VhcmNoL3NlcnZpY2UvdG9waWMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxZQUFZLEVBQXFCLE1BQU0saUJBQWlCLENBQUM7QUFDcEYsT0FBTyxFQUFFLE9BQU8sRUFBYyxlQUFlLEVBQW9CLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7Ozs7QUFVdEMsTUFBTSxPQUFPLFlBQVk7SUFVdkIsWUFDVSxhQUFnQyxFQUNoQyxtQkFBNkMsRUFDckQsTUFBYyxFQUNiLElBQWdCO1FBSFQsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ2hDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBMEI7UUFUL0MsVUFBSyxHQUFxQyxJQUFJLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQWEzRSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksZ0JBQWdCLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUMsQ0FBRTtJQUN6RSxDQUFDO0lBRU0sY0FBYyxDQUFDLE1BQTBCO1FBQzlDLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztRQUN0QyxJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUM7UUFDdEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxnQkFB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QUFDLEtBQUssRUFBRSxDQUFDO1FBQy9DLENBQUMsQ0FBQyxFQUNGLEtBQUssRUFBRSxFQUNQLFVBQVUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQzlCLENBQUM7SUFDSixDQUFDO0lBRU8sWUFBWSxDQUFDLEtBQVUsRUFBRSxNQUF1QjtRQUN0RCxJQUFJLE1BQWMsQ0FBQztRQUNuQixJQUFJLEtBQUssWUFBWSxRQUFRLEVBQUU7WUFDN0IsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDbEUsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sTUFBTSxLQUFLLENBQUMsVUFBVSxJQUFJLEVBQUUsSUFBSSxHQUFHLEVBQUUsQ0FBQztTQUMvRDthQUFNO1lBQ0wsTUFBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUMzRDtRQUNELE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFRCxRQUFRO1FBQ04sT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ25DLENBQUM7O3lHQWpQVSxZQUFZOzZHQUFaLFlBQVksY0FGWCxNQUFNOzJGQUVQLFlBQVk7a0JBSHhCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRW5kZWNhcG9kU2VydmljZSwgU2VhcmNoUmVzdWx0LCBFZGNhVXJsU2VyaWFsaXplciB9IGZyb20gJ0BpYmZkL2VuZGVjYXBvZCc7XG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGVJbnB1dCwgIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBmaWx0ZXIsIG1hcCwgZmlyc3QsIGNvbmNhdE1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBUb3BpY1NlcnZpY2VDb25maWcgfSBmcm9tICcuLi9tb2RlbC90b3BpYy1zZXJ2aWNlLWNvbmZpZyc7XG5pbXBvcnQgeyBUb3BpY0NvbmZpZyB9IGZyb20gJy4uL21vZGVsL3RvcGljLWNvbmZpZyc7XG5pbXBvcnQgeyBUYXh0b3BpY3NQcm92aWRlclNlcnZpY2UgfSBmcm9tICcuL3RheHRvcGljcy1wcm92aWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUb3BpY1NlcnZpY2Uge1xuICBwcml2YXRlIHRvcGljVHJlZVByb3ZpZGVyOiBTdWJqZWN0PGFueT47XG4gIHByaXZhdGUgZG9jVG9waWNUcmVlUHJvdmlkZXI6IFN1YmplY3Q8YW55PjtcbiAgcHJpdmF0ZSBlcnJvcjogQmVoYXZpb3JTdWJqZWN0PEVycm9yIHwgYm9vbGVhbj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KGZhbHNlKTtcbiAgcHJpdmF0ZSBpbml0VG9waWNTdmM6IEVuZGVjYXBvZFNlcnZpY2U7XG4gIHByaXZhdGUgX2VuZGVjYVVybDogc3RyaW5nO1xuICBwcml2YXRlIF9hd2FyZVVybDogc3RyaW5nO1xuICBwcml2YXRlIF9zdXBwcmVzc2VkQ2hpcHM6IG51bWJlcltdO1xuICBwcml2YXRlIHRvcGljQ29uZmlnOiBUb3BpY0NvbmZpZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHVybFNlcmlhbGl6ZXI6IEVkY2FVcmxTZXJpYWxpemVyLFxuICAgIHByaXZhdGUgdGF4dG9waWNQcm92aWRlclN2YzogVGF4dG9waWNzUHJvdmlkZXJTZXJ2aWNlLFxuICAgIHJvdXRlcjogUm91dGVyLFxuICAgICBodHRwOiBIdHRwQ2xpZW50LFxuICApIHtcbiAgICB0aGlzLmluaXRUb3BpY1N2YyA9IG5ldyBFbmRlY2Fwb2RTZXJ2aWNlKGh0dHAsIHJvdXRlciwgdXJsU2VyaWFsaXplcikgO1xuICB9XG5cbiAgcHVibGljIHJlZ2lzdGVyQ29uZmlnKGNvbmZpZzogVG9waWNTZXJ2aWNlQ29uZmlnKTogdm9pZCB7XG4gICAgdGhpcy50b3BpY0NvbmZpZyA9IGNvbmZpZy50b3BpY0NvbmZpZztcbiAgICB0aGlzLl9lbmRlY2FVcmwgPSBjb25maWcuZW5kZWNhcG9kVXJsO1xuICAgIHRoaXMuX2F3YXJlVXJsID0gY29uZmlnLmF3YXJlVXJsO1xuICAgIHRoaXMuX3N1cHByZXNzZWRDaGlwcyA9IGNvbmZpZy5zdXBwcmVzc2VkQ2hpcHM7XG4gIH1cblxuICBwdWJsaWMgbG9hZEluaXRUYXhUb3BpY3MoKSB7XG4gICAgdGhpcy5zaG91bGRGZXRjaEluaXRpYWxUYXh0b3BpY3MoKVxuICAgICAgLnBpcGUoZmlsdGVyKEJvb2xlYW4pLCB0YWtlKDEpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiAgdGhpcy5mZXRjaEluaXRpYWxUYXh0b3BpY3MoKSk7XG5cbiAgICB0aGlzLmdldFRvcGljVmFsdWVzKHRoaXMuaW5pdFRvcGljU3ZjLlJlc3VsdCgpKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChyZXMgPT4ge1xuICAgICAgICAgIGNvbnN0IHRvcGljcyA9IHJlcy50b3BpY3M7XG4gICAgICAgICAgT2JqZWN0LmtleXModG9waWNzKS5tYXAoZSA9PiB0b3BpY3NbZV0pXG4gICAgICAgICAgICAuZm9yRWFjaChvYmogPT4gb2JqWydzZWxlY3RhYmxlJ10gPSBmYWxzZSk7XG4gICAgICAgICAgcmV0dXJuIHRvcGljcztcbiAgICAgICAgfSksXG4gICAgICAgIHRha2UoMSksXG4gICAgICAgIGNhdGNoRXJyb3IodGhpcy5oYW5kbGVfZXJyb3IpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKFxuICAgICAgICB0ID0+IHtcbiAgICAgICAgICB0aGlzLnRheHRvcGljUHJvdmlkZXJTdmMuYWRkVGF4dG9waWNzR3JvdXAodCwgdGhpcy50b3BpY0NvbmZpZy5pZCk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIHNob3VsZEZldGNoSW5pdGlhbFRheHRvcGljcygpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBpbml0UXVlcnkgPSB0aGlzLnRvcGljQ29uZmlnLnF1ZXJ5O1xuICAgIGlmICghaW5pdFF1ZXJ5IHx8IGluaXRRdWVyeS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudGF4dG9waWNQcm92aWRlclN2Yy5pc1RheHRvcGljc0dyb3VwRXhpc3QodGhpcy50b3BpY0NvbmZpZy5pZClcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZXhpc3QgPT4gIWV4aXN0KVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZmV0Y2hJbml0aWFsVGF4dG9waWNzKCkge1xuICAgIHRoaXMuaW5pdFRvcGljU3ZjLnNldE5hbWUoJ1RvcGljVHJlZUluaXRTZXJ2aWNlJyk7XG4gICAgdGhpcy5pbml0VG9waWNTdmMuc2V0VVJMKHRoaXMuX2VuZGVjYVVybCwgdGhpcy5fYXdhcmVVcmwpO1xuICAgIHRoaXMuaW5pdFRvcGljU3ZjLlJlZ2lzdGVyUGFyYW1zKFxuICAgICAgdGhpcy51cmxTZXJpYWxpemVyLnBhcnNlKCc/JyArIHRoaXMudG9waWNDb25maWcucXVlcnkpLnF1ZXJ5UGFyYW1NYXBcbiAgICApO1xuICAgIHRoaXMuaW5pdFRvcGljU3ZjLkRvU2VhcmNoKCk7XG4gIH1cblxuICBidWlsZFRvcGljVHJlZShzZWFyY2hlZFRvcGljczogT2JqZWN0LCBleHBhbmRlZE5vZGVzOiBTZXQ8bnVtYmVyPikge1xuICAgIHRoaXMudGF4dG9waWNQcm92aWRlclN2Yy5nZXRUYXh0b3BpY3ModGhpcy50b3BpY0NvbmZpZy5pZClcbiAgICAucGlwZShmaWx0ZXIodGF4dG9waWNzID0+ICEhdGF4dG9waWNzKSlcbiAgICAuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6IHRheHRvcGljcyA9PiB7XG4gICAgICAgIC8vIFVwZGF0aW5nIHRheG9ub215IHRheHRvcGljcyBieSBzZWFyY2hlZCB0b3BpY3MgZnJvbSBlbmRlY2FcbiAgICAgICAgY29uc3QgY2xvbmVkVGF4dG9waWNzID0gY2xvbmVEZWVwKHRheHRvcGljcyk7XG4gICAgICAgIHRoaXMudXBkYXRlQXZhaWxhYmxlVG9waWNzKGNsb25lZFRheHRvcGljcywgT2JqZWN0LmtleXMoc2VhcmNoZWRUb3BpY3NbJ3RvcGljcyddKSk7XG4gICAgICAgIHRoaXMudG9waWNUcmVlUHJvdmlkZXIubmV4dCh0aGlzLmJ1aWxkUHJpbWVOZ1RyZWUoY2xvbmVkVGF4dG9waWNzLCBzZWFyY2hlZFRvcGljc1snY2hpcHMnXSwgZXhwYW5kZWROb2RlcykpO1xuICAgICAgfSxcbiAgICAgIGVycm9yOiBlcnIgPT4geyB0aGlzLmVycm9yLm5leHQoZXJyKTsgfVxuICAgIH0pO1xuICB9XG5cbiAgYnVpbGREb2NUb3BpY1RyZWUodG9waWNDb2Rlczogc3RyaW5nW10pIHtcbiAgICB0aGlzLnRheHRvcGljUHJvdmlkZXJTdmMuZ2V0VGF4dG9waWNzKHRoaXMudG9waWNDb25maWcuaWQpXG4gICAgLnBpcGUoZmlsdGVyKHRheHRvcGljcyA9PiAhIXRheHRvcGljcykpXG4gICAgLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiB0YXh0b3BpY3MgPT4ge1xuICAgICAgICBjb25zdCBjbG9uZWRUYXh0b3BpY3MgPSBjbG9uZURlZXAodGF4dG9waWNzKTtcbiAgICAgICAgdGhpcy51cGRhdGVBdmFpbGFibGVEb2NUb3BpY3MoY2xvbmVkVGF4dG9waWNzLCB0b3BpY0NvZGVzKTtcbiAgICAgICAgY29uc3QgZG9jVG9waWNUcmVlID0gdGhpcy5idWlsZFByaW1lTmdUcmVlKGNsb25lZFRheHRvcGljcywgW10sIG5ldyBTZXQoKSkuZGF0YTtcbiAgICAgICAgdGhpcy5kb2NUb3BpY1RyZWVQcm92aWRlci5uZXh0KGRvY1RvcGljVHJlZSk7XG4gICAgICB9LFxuICAgICAgZXJyb3I6IGVyciA9PiB7IHRoaXMuZXJyb3IubmV4dChlcnIpOyB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUF2YWlsYWJsZURvY1RvcGljcyh0YXh0b3BpY3M6IE9iamVjdCwgdG9waWNDb2Rlczogc3RyaW5nW10pIHtcbiAgICB0b3BpY0NvZGVzLmZvckVhY2godG9waWNDb2RlID0+IHtcbiAgICAgIGNvbnN0IHRheHRvcGljID0gdGF4dG9waWNzW3RvcGljQ29kZV07XG4gICAgICBpZiAodGF4dG9waWMpIHtcbiAgICAgICAgdGF4dG9waWMuc2VsZWN0YWJsZSA9IHRydWU7XG4gICAgICAgIGxldCBwYXJlbnRMYWJlbCA9IHRoaXMuZ2V0VGF4dG9waWNQYXJlbnRMYWJlbCh0b3BpY0NvZGUpO1xuICAgICAgICB3aGlsZSAocGFyZW50TGFiZWwubGFzdEluZGV4T2YoJ18nKSA+IDApIHtcbiAgICAgICAgICBjb25zdCBwYXJlbnQgPSB0YXh0b3BpY3NbcGFyZW50TGFiZWxdO1xuICAgICAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgICAgIHBhcmVudC5zZWxlY3RhYmxlID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcGFyZW50TGFiZWwgPSB0aGlzLmdldFRheHRvcGljUGFyZW50TGFiZWwocGFyZW50TGFiZWwpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUF2YWlsYWJsZVRvcGljcyh0YXh0b3BpY3M6IE9iamVjdCwgdG9waWNDb2Rlczogc3RyaW5nW10pIHtcbiAgICB0b3BpY0NvZGVzLmZvckVhY2godG9waWNDb2RlID0+IHtcbiAgICAgIGNvbnN0IHRheHRvcGljID0gdGF4dG9waWNzW3RvcGljQ29kZV07XG4gICAgICBpZiAodGF4dG9waWMpIHtcbiAgICAgICAgdGF4dG9waWMuc2VsZWN0YWJsZSA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBnZXRUb3BpY1RyZWUoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gKHRoaXMudG9waWNUcmVlUHJvdmlkZXIgPSB0aGlzLnRvcGljVHJlZVByb3ZpZGVyIHx8IG5ldyBTdWJqZWN0PGFueT4oKSkuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBnZXREb2NUb3BpY1RyZWUoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gKHRoaXMuZG9jVG9waWNUcmVlUHJvdmlkZXIgPSB0aGlzLmRvY1RvcGljVHJlZVByb3ZpZGVyIHx8IG5ldyBTdWJqZWN0PGFueT4oKSkuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkUHJpbWVOZ1RyZWUodGF4dG9waWNzOiBPYmplY3QsIGNoaXBzOiBhbnlbXSwgZXhwYW5kZWROb2RlczogU2V0PG51bWJlcj4pIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGF4dG9waWNzKVxuICAgIC5tYXAoZSA9PiB0YXh0b3BpY3NbZV0pXG4gICAgLnJlZHVjZSgoYWNjLCB0YXh0b3BpYykgPT4ge1xuICAgICAgY29uc3Qgbm9kZSA9IHtcbiAgICAgICAgbGFiZWw6IHRheHRvcGljWydsYWJlbCddLFxuICAgICAgICBkYXRhOiB0YXh0b3BpY1snY29kZSddLFxuICAgICAgICBzZWxlY3RhYmxlOiB0YXh0b3BpY1snc2VsZWN0YWJsZSddLFxuICAgICAgICBpZDogdGF4dG9waWNbJ2lkJ10sXG4gICAgICAgIGtleTogdGF4dG9waWNbJ2NvZGUnXVxuICAgICAgfTtcbiAgICAgIGlmIChjaGlwcy5maW5kKGlkID0+IGlkID09PSBub2RlLmlkKSkge1xuICAgICAgICBhY2Muc2VsZWN0ZWQucHVzaChub2RlKTtcbiAgICAgIH1cbiAgICAgIG5vZGVbJ2V4cGFuZGVkJ10gPSBleHBhbmRlZE5vZGVzLmhhcyhub2RlLmlkKTtcbiAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZ2V0VGF4dG9waWNQYXJlbnQoYWNjLmRhdGEsIHRoaXMuZ2V0VGF4dG9waWNQYXJlbnRMYWJlbChub2RlLmRhdGEpKTtcbiAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgaWYgKCFwYXJlbnRbJ2NoaWxkcmVuJ10pIHtcbiAgICAgICAgICBwYXJlbnRbJ2NoaWxkcmVuJ10gPSBbXTtcbiAgICAgICAgfVxuICAgICAgICBub2RlWydwYXJlbnQnXSA9IHBhcmVudDtcbiAgICAgICAgcGFyZW50WydjaGlsZHJlbiddLnB1c2gobm9kZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhY2MuZGF0YS5wdXNoKG5vZGUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7ZGF0YTogW10sIHNlbGVjdGVkOiBbXX0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUYXh0b3BpY1BhcmVudExhYmVsKHRjOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGMuc3Vic3RyaW5nKDAsIHRjLmxhc3RJbmRleE9mKCdfJykpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUYXh0b3BpY1BhcmVudChhY2M6IE9iamVjdFtdLCBwYXJlbnRMYWJlbDogc3RyaW5nKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhY2MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHRheHRvcGljID0gYWNjW2ldO1xuICAgICAgaWYgKHRheHRvcGljWydkYXRhJ10gPT09IHBhcmVudExhYmVsKSB7XG4gICAgICAgIHJldHVybiB0YXh0b3BpYztcbiAgICAgIH1cbiAgICAgIGlmICh0YXh0b3BpY1snY2hpbGRyZW4nXSkge1xuICAgICAgICBjb25zdCB0YXh0b3BpY1BhcmVudCA9IHRoaXMuZ2V0VGF4dG9waWNQYXJlbnQodGF4dG9waWNbJ2NoaWxkcmVuJ10sIHBhcmVudExhYmVsKTtcbiAgICAgICAgaWYgKHRheHRvcGljUGFyZW50KSB7XG4gICAgICAgICAgcmV0dXJuIHRheHRvcGljUGFyZW50O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc2VhcmNoVG9waWNzKHRvcGljRXhwb3NlU2VydmljZTogRW5kZWNhcG9kU2VydmljZSwgZW5kZWNhcG9kU2VydmljZTogRW5kZWNhcG9kU2VydmljZSk6IE9ic2VydmFibGU8Ym9vbGVhbiB8IFNlYXJjaFJlc3VsdD4ge1xuICAgIHJldHVybiBlbmRlY2Fwb2RTZXJ2aWNlLnJ1bm5pbmdxdWVyeSgpLnBpcGUoZmlsdGVyKHJxID0+ICEhcnEpLCBjb25jYXRNYXAoXG4gICAgICBxID0+IHtcbiAgICAgICAgdG9waWNFeHBvc2VTZXJ2aWNlLkV4cG9zZU11bHRpcGxlT25FeGlzdGluZyhcbiAgICAgICAgICBlbmRlY2Fwb2RTZXJ2aWNlLFxuICAgICAgICAgIHRoaXMudG9waWNDb25maWcuZGltZW5zaW9ucy5tYXAoZGltID0+IGRpbS5pZCksXG4gICAgICAgICAgdGhpcy50b3BpY0NvbmZpZy5kaW1lbnNpb25zLm1hcChkaW0gPT4gZGltLm5hbWUpLmpvaW4oJywnKVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRUb3BpY1ZhbHVlcyh0b3BpY0V4cG9zZVNlcnZpY2UuUmVzdWx0KCkpO1xuICAgICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUb3BpY1ZhbHVlcyhzZWFyY2hyZXN1bHQ6IE9ic2VydmFibGU8Ym9vbGVhbiB8IFNlYXJjaFJlc3VsdD4pIHtcbiAgICByZXR1cm4gc2VhcmNocmVzdWx0LnBpcGUoXG4gICAgICBmaWx0ZXIocmVzID0+IHJlcyBpbnN0YW5jZW9mIFNlYXJjaFJlc3VsdCksXG4gICAgICBtYXAoKHJlczogU2VhcmNoUmVzdWx0KSA9PiB7XG4gICAgICAgIGxldCB0b3BpY3MgPSBbXTtcbiAgICAgICAgdGhpcy50b3BpY0NvbmZpZy5kaW1lbnNpb25zXG4gICAgICAgICAgLmZvckVhY2goZCA9PiB7XG4gICAgICAgICAgICB0b3BpY3MgPSB0b3BpY3MuY29uY2F0KHJlcy5nZXREaW1lbnNpb25WYWx1ZXNPckFzc29jaWF0ZWQoZCkpO1xuICAgICAgICAgIH0pO1xuICAgICAgICBjb25zdCBjaGlwcyA9IHJlcy5nZXRDaGlwcygpXG4gICAgICAgICAgLmZpbHRlcihjMSA9PiAhdGhpcy5fc3VwcHJlc3NlZENoaXBzLmZpbmQocyA9PiBjMS5wYXJlbnQuaWQgPT09IHMpKVxuICAgICAgICAgIC5tYXAoY2hpcCA9PiBjaGlwLmRpbWVuc2lvbi5pZCk7XG4gICAgICAgIHJldHVybiB7dG9waWNzOiB0b3BpY3MsIGNoaXBzOiBjaGlwc307XG4gICAgICB9KSxcbiAgICAgIGZpcnN0KCksXG4gICAgICBtYXAob2JqID0+IHtcbiAgICAgICAgY29uc3QgdG9waWNzID0gb2JqLnRvcGljc1xuICAgICAgICAgIC5tYXAodG9waWMgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IHRvcGljLm5hbWU7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBjb2RlOiBuYW1lLnN1YnN0cmluZygwLCBuYW1lLmluZGV4T2YoJyAnKSksXG4gICAgICAgICAgICAgIGxhYmVsOiBuYW1lLnN1YnN0cmluZyhuYW1lLmluZGV4T2YoJyAnKSArIDEpLFxuICAgICAgICAgICAgICBpZDogdG9waWMuaWRcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuc29ydCgodDEsIHQyKSA9PiB0MS5jb2RlLmxvY2FsZUNvbXBhcmUodDIuY29kZSwgdW5kZWZpbmVkLCB7IG51bWVyaWM6IHRydWUsIHNlbnNpdGl2aXR5OiAnYmFzZScgfSkpXG4gICAgICAgICAgLnJlZHVjZSgoYWNjLCB0b3BpYykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oYWNjLCB7IFt0b3BpY1snY29kZSddXTogdG9waWMgfSk7XG4gICAgICAgICAgfSwge30pO1xuICAgICAgICAgIHJldHVybiB7dG9waWNzOiB0b3BpY3MsIGNoaXBzOiBvYmouY2hpcHMgfTtcbiAgICAgIH0pLFxuICAgICAgZmlyc3QoKSxcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5oYW5kbGVfZXJyb3IpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlX2Vycm9yKGVycm9yOiBhbnksIGNhdWdodDogT2JzZXJ2YWJsZTxhbnk+KTogT2JzZXJ2YWJsZUlucHV0PHt9PiB7XG4gICAgbGV0IGVyck1zZzogc3RyaW5nO1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFJlc3BvbnNlKSB7XG4gICAgICBjb25zdCBlcnIgPSBlcnJvci5qc29uKCkudGhlbihqc29uID0+IEpTT04uc3RyaW5naWZ5KGpzb24pKSB8fCAnJztcbiAgICAgIGVyck1zZyA9IGAke2Vycm9yLnN0YXR1c30gLSAke2Vycm9yLnN0YXR1c1RleHQgfHwgJyd9ICR7ZXJyfWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVyck1zZyA9IGVycm9yLm1lc3NhZ2UgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgdGhyb3cgKG5ldyBFcnJvcihlcnJNc2cpKTtcbiAgfVxuXG4gIGdldEVycm9yKCk6IE9ic2VydmFibGU8RXJyb3IgfCBCb29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuZXJyb3IuYXNPYnNlcnZhYmxlKCk7XG4gIH1cbn1cbiJdfQ==